<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–ª–∏–µ–Ω—Ç—ã - Banker Portal</title>
    <style id="sidebar-styles"></style>
    <style>
        /* Page-specific styles */
        .search-filter-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .filter-box {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-box select {
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
            cursor: pointer;
        }

        .clients-table-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .clients-table {
            width: 100%;
            border-collapse: collapse;
        }

        .clients-table th {
            background: var(--bg-primary);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
        }

        .clients-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .clients-table tr:hover {
            background: var(--bg-primary);
        }

        .segment-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .segment-premium { background: #fef3c7; color: #92400e; }
        .segment-mass { background: #dbeafe; color: #1e40af; }
        .segment-vip { background: #fce7f3; color: #9f1239; }

        [data-theme="dark"] .segment-premium { background: #78350f; color: #fef3c7; }
        [data-theme="dark"] .segment-mass { background: #1e3a8a; color: #dbeafe; }
        [data-theme="dark"] .segment-vip { background: #831843; color: #fce7f3; }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 24px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-size-selector select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <main class="main-content">
        <div class="top-bar">
            <div class="top-bar-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</div>
        </div>

        <div class="content-area">
            <div class="container">
                <!-- Search and Filter -->
                <div class="search-filter-bar">
                    <div class="search-box">
                        <input type="text" id="clientSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, ID –∏–ª–∏ —Å–µ–≥–º–µ–Ω—Ç—É...">
                    </div>
                    <div class="filter-box">
                        <select id="segmentFilter">
                            <option value="">–í—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã</option>
                            <option value="MASS">–ú–∞—Å—Å–æ–≤—ã–π</option>
                            <option value="PREMIUM">–ü—Ä–µ–º–∏—É–º</option>
                            <option value="VIP">VIP</option>
                        </select>
                    </div>
                </div>

                <!-- Clients Table -->
                <div class="clients-table-container">
                    <table class="clients-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–¢–∏–ø</th>
                                <th>–°–µ–≥–º–µ–Ω—Ç</th>
                                <th>–î–æ—Ö–æ–¥</th>
                                <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <tr>
                                <td colspan="6" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination">
                    <div class="pagination-info" id="paginationInfo">
                        –ü–æ–∫–∞–∑–∞–Ω–æ 0-0 –∏–∑ 0
                    </div>
                    <div class="pagination-controls" id="paginationControls">
                        <!-- Will be populated by JS -->
                    </div>
                    <div class="page-size-selector">
                        <label for="pageSize">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
                        <select id="pageSize">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../client/theme-switcher.js"></script>
    <script type="module">
        import { initSidebar, sidebarStyles } from './sidebar.js';

        // Apply styles
        document.getElementById('sidebar-styles').textContent = sidebarStyles;
        
        // Initialize sidebar
        initSidebar('clients');
        
        // Apply theme
        if (window.applyTheme) {
            window.applyTheme();
        }

        // Setup theme toggle
        document.getElementById('themeToggle').addEventListener('click', () => {
            if (window.toggleTheme) {
                window.toggleTheme();
            }
            const isDark = localStorage.getItem('theme') === 'dark';
            document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        });

        // Update theme icon on load
        const isDark = localStorage.getItem('theme') === 'dark';
        document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    </script>

    <script>
        // Check authentication
        const token = localStorage.getItem('banker_token');
        if (!token) {
            window.location.href = 'index.html';
        }

        function getBaseUrl() {
            const port = window.location.port;
            return `http://localhost:${port}`;
        }

        // State
        let allClients = [];
        let filteredClients = [];
        let currentPage = 1;
        let pageSize = 25;

        // Load clients
        async function loadClients() {
            try {
                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/banker/clients`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                
                // Ensure data is an array
                allClients = Array.isArray(data) ? data : [];
                filteredClients = [...allClients];
                
                renderClients();
            } catch (error) {
                console.error('Error loading clients:', error);
                document.getElementById('clientsTableBody').innerHTML = `
                    <tr><td colspan="6" class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤: ${error.message}</td></tr>
                `;
            }
        }

        // Render clients
        function renderClients() {
            const tbody = document.getElementById('clientsTableBody');
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = startIdx + pageSize;
            const pageClients = filteredClients.slice(startIdx, endIdx);

            if (pageClients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-muted);">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                updatePagination();
                return;
            }

            tbody.innerHTML = pageClients.map(client => `
                <tr>
                    <td><code style="font-size:12px;">${client.person_id.substring(0, 8)}...</code></td>
                    <td><strong>${client.full_name}</strong></td>
                    <td>${client.client_type === 'INDIVIDUAL' ? '–§–∏–∑. –ª–∏—Ü–æ' : '–Æ—Ä. –ª–∏—Ü–æ'}</td>
                    <td><span class="segment-badge segment-${client.segment.toLowerCase()}">${client.segment}</span></td>
                    <td>${client.monthly_income ? `${Number(client.monthly_income).toLocaleString('ru-RU')} ‚ÇΩ` : '‚Äî'}</td>
                    <td>${client.created_at ? new Date(client.created_at).toLocaleDateString('ru-RU') : '‚Äî'}</td>
                </tr>
            `).join('');

            updatePagination();
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredClients.length / pageSize);
            const startIdx = (currentPage - 1) * pageSize + 1;
            const endIdx = Math.min(currentPage * pageSize, filteredClients.length);

            // Update info
            document.getElementById('paginationInfo').textContent = 
                `–ü–æ–∫–∞–∑–∞–Ω–æ ${startIdx}-${endIdx} –∏–∑ ${filteredClients.length}`;

            // Update controls
            const controls = document.getElementById('paginationControls');
            controls.innerHTML = '';

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.textContent = '‚Üê';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderClients();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            controls.appendChild(prevBtn);

            // Page buttons (smart pagination)
            const pages = [];
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) pages.push(i);
            } else {
                pages.push(1);
                if (currentPage > 3) pages.push('...');
                for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                    pages.push(i);
                }
                if (currentPage < totalPages - 2) pages.push('...');
                pages.push(totalPages);
            }

            pages.forEach(page => {
                if (page === '...') {
                    const span = document.createElement('span');
                    span.textContent = '...';
                    span.style.padding = '8px';
                    span.style.color = 'var(--text-muted)';
                    controls.appendChild(span);
                } else {
                    const btn = document.createElement('button');
                    btn.className = `pagination-btn ${page === currentPage ? 'active' : ''}`;
                    btn.textContent = page;
                    btn.onclick = () => {
                        currentPage = page;
                        renderClients();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    };
                    controls.appendChild(btn);
                }
            });

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.textContent = '‚Üí';
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderClients();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            controls.appendChild(nextBtn);
        }

        // Search and filter
        function applyFilters() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
            const segment = document.getElementById('segmentFilter').value;

            filteredClients = allClients.filter(client => {
                const matchesSearch = !searchTerm || 
                    client.full_name.toLowerCase().includes(searchTerm) ||
                    client.person_id.toLowerCase().includes(searchTerm) ||
                    client.segment.toLowerCase().includes(searchTerm);
                
                const matchesSegment = !segment || client.segment === segment;

                return matchesSearch && matchesSegment;
            });

            currentPage = 1;
            renderClients();
        }

        // Event listeners
        document.getElementById('clientSearch').addEventListener('input', applyFilters);
        document.getElementById('segmentFilter').addEventListener('change', applyFilters);
        document.getElementById('pageSize').addEventListener('change', (e) => {
            pageSize = parseInt(e.target.value);
            currentPage = 1;
            renderClients();
        });

        // Initial load
        loadClients();
    </script>
</body>
</html>
