<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–≥–ª–∞—Å–∏—è - Banker Portal</title>
    <style id="sidebar-styles"></style>
    <style>
        /* Page-specific styles */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-box {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-muted);
        }

        .consents-table-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .consents-table {
            width: 100%;
            border-collapse: collapse;
        }

        .consents-table th {
            background: var(--bg-primary);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            font-size: 14px;
        }

        .consents-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .consents-table tr:hover {
            background: var(--bg-primary);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-AUTHORIZED { background: #d1fae5; color: #065f46; }
        .status-PENDING { background: #fef3c7; color: #92400e; }
        .status-REJECTED { background: #fee2e2; color: #991b1b; }
        .status-REVOKED { background: #e5e7eb; color: #4b5563; }

        [data-theme="dark"] .status-AUTHORIZED { background: #064e3b; color: #d1fae5; }
        [data-theme="dark"] .status-PENDING { background: #78350f; color: #fef3c7; }
        [data-theme="dark"] .status-REJECTED { background: #7f1d1d; color: #fee2e2; }
        [data-theme="dark"] .status-REVOKED { background: #374151; color: #e5e7eb; }

        .permissions-list {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .search-box {
            margin-bottom: 24px;
        }

        .search-box input {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <main class="main-content">
        <div class="top-bar">
            <div class="top-bar-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏—è–º–∏</div>
        </div>

        <div class="content-area">
            <div class="container">
                <!-- Stats -->
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-value" id="totalConsents">‚Äî</div>
                        <div class="stat-label">–í—Å–µ–≥–æ —Å–æ–≥–ª–∞—Å–∏–π</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="authorizedConsents">‚Äî</div>
                        <div class="stat-label">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="pendingConsents">‚Äî</div>
                        <div class="stat-label">–í –æ–∂–∏–¥–∞–Ω–∏–∏</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="revokedConsents">‚Äî</div>
                        <div class="stat-label">–û—Ç–æ–∑–≤–∞–Ω–æ</div>
                    </div>
                </div>

                <!-- Search -->
                <div class="search-box">
                    <input type="text" id="consentSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ ID —Å–æ–≥–ª–∞—Å–∏—è –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞...">
                </div>

                <!-- Consents Table -->
                <div class="consents-table-container">
                    <table class="consents-table">
                        <thead>
                            <tr>
                                <th>ID –°–æ–≥–ª–∞—Å–∏—è</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–ó–∞–ø—Ä–∞—à–∏–≤–∞—é—â–∏–π –±–∞–Ω–∫</th>
                                <th>–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–°–æ–∑–¥–∞–Ω–æ</th>
                                <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
                            </tr>
                        </thead>
                        <tbody id="consentsTableBody">
                            <tr>
                                <td colspan="7" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–≥–ª–∞—Å–∏–π...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="../client/theme-switcher.js"></script>
    <script type="module">
        import { initSidebar, sidebarStyles } from './sidebar.js';

        // Apply styles
        document.getElementById('sidebar-styles').textContent = sidebarStyles;
        
        // Initialize sidebar
        initSidebar('consents');
        
        // Apply theme
        if (window.applyTheme) {
            window.applyTheme();
        }

        // Setup theme toggle
        document.getElementById('themeToggle').addEventListener('click', () => {
            if (window.toggleTheme) {
                window.toggleTheme();
            }
            const isDark = localStorage.getItem('theme') === 'dark';
            document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        });

        // Update theme icon on load
        const isDark = localStorage.getItem('theme') === 'dark';
        document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    </script>

    <script>
        // Check authentication
        const token = localStorage.getItem('banker_token');
        if (!token) {
            window.location.href = 'index.html';
        }

        function getBaseUrl() {
            const port = window.location.port;
            return `http://localhost:${port}`;
        }

        let allConsents = [];
        let filteredConsents = [];

        // Load consents
        async function loadConsents() {
            try {
                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/admin/consents`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                allConsents = data.consents || [];
                filteredConsents = [...allConsents];
                
                updateStats();
                renderConsents();
            } catch (error) {
                console.error('Error loading consents:', error);
                document.getElementById('consentsTableBody').innerHTML = 
                    `<tr><td colspan="7" class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</td></tr>`;
            }
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalConsents').textContent = allConsents.length;
            document.getElementById('authorizedConsents').textContent = 
                allConsents.filter(c => c.status === 'AUTHORIZED').length;
            document.getElementById('pendingConsents').textContent = 
                allConsents.filter(c => c.status === 'PENDING').length;
            document.getElementById('revokedConsents').textContent = 
                allConsents.filter(c => c.status === 'REVOKED').length;
        }

        // Render consents
        function renderConsents() {
            const tbody = document.getElementById('consentsTableBody');

            if (filteredConsents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted);">–°–æ–≥–ª–∞—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                return;
            }

            tbody.innerHTML = filteredConsents.map(consent => {
                const permissions = consent.permissions || [];
                const permissionsText = permissions.slice(0, 2).join(', ') + 
                    (permissions.length > 2 ? ` +${permissions.length - 2}` : '');

                return `
                    <tr>
                        <td><code style="font-size:12px;">${consent.consent_id.substring(0, 12)}...</code></td>
                        <td><strong>${consent.client_id}</strong></td>
                        <td>${consent.requesting_bank || '‚Äî'}</td>
                        <td>
                            <div>${permissionsText}</div>
                            ${permissions.length > 2 ? `<div class="permissions-list">${permissions.join(', ')}</div>` : ''}
                        </td>
                        <td><span class="status-badge status-${consent.status}">${consent.status}</span></td>
                        <td>${new Date(consent.created_at).toLocaleDateString('ru-RU')}</td>
                        <td>${consent.expiration_date ? new Date(consent.expiration_date).toLocaleDateString('ru-RU') : '‚Äî'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Search
        document.getElementById('consentSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            filteredConsents = allConsents.filter(consent => {
                return consent.consent_id.toLowerCase().includes(searchTerm) ||
                       consent.client_id.toLowerCase().includes(searchTerm) ||
                       (consent.requesting_bank && consent.requesting_bank.toLowerCase().includes(searchTerm));
            });

            renderConsents();
        });

        // Initial load
        loadConsents();
    </script>
</body>
</html>
